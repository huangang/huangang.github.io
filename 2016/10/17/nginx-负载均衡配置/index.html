<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> nginx 负载均衡配置 · zorro_ku_o's blog</title><meta name="description" content="nginx 负载均衡配置 - zorro_ku_o"><meta name="viewport" content="width=device-width, initial-scale=1"><meta http-equiv="X-Frame-Options" content="deny"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/about.html" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="http://weibo.com/zhanghuangang/" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">nginx 负载均衡配置</h1><div class="post-info">2016年10月17日</div><div class="post-content"><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">upstream api.com &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:81 <span class="attribute">weight</span>=2 <span class="attribute">max_fails</span>=3 <span class="attribute">fail_timeout</span>=15;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:82 <span class="attribute">weight</span>=3;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:83 backup;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:84 down;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:85 <span class="attribute">max_conns</span>=1000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<a id="more"></a>   
<h2 id="1-轮循（默认）"><a href="#1-轮循（默认）" class="headerlink" title="1.轮循（默认）"></a>1.轮循（默认）</h2><p>轮询即Round Robin，根据Nginx配置文件中的顺序，<br>依次把客户端的Web请求分发到不同的后端服务器上</p>
<h2 id="2、最少连接-least-conn"><a href="#2、最少连接-least-conn" class="headerlink" title="2、最少连接 least_conn;"></a>2、最少连接 least_conn;</h2><p>Web请求会被转发到连接数最少的服务器上。</p>
<h2 id="3、IP地址哈希-ip-hash"><a href="#3、IP地址哈希-ip-hash" class="headerlink" title="3、IP地址哈希 ip_hash;"></a>3、IP地址哈希 ip_hash;</h2><p>前述的两种负载均衡方案中，同一客户端连续的Web请求可能会被分发到不同的后端服务器进行处理，<br>因此如果涉及到会话Session，那么会话会比较复杂。常见的是基于数据库的会话持久化。<br>要克服上面的难题，可以使用基于IP地址哈希的负载均衡方案。<br>这样的话，同一客户端连续的Web请求都会被分发到同一服务器进行处理。</p>
<h2 id="4、基于权重-weight"><a href="#4、基于权重-weight" class="headerlink" title="4、基于权重 weight"></a>4、基于权重 weight</h2><p>基于权重的负载均衡即Weighted Load Balancing，<br>这种方式下，我们可以配置Nginx把请求更多地分发到高配置的后端服务器上，<br>把相对较少的请求分发到低配服务器。</p>
<p><code>weight</code><br>默认为1，将请求平均分配给每台server<br><code>backup</code><br>备份机，所有服务器挂了之后才会生效<br><code>down</code><br>标识某一台server不可用。可能能通过某些参数动态的激活它吧，要不真没啥用。<br><code>fail_timeout</code><br>默认为10秒。某台Server达到max_fails次失败请求后，在fail_timeout期间内，nginx会认为这台Server暂时不可用，不会将请求分配给它<br><code>max_fails</code><br>默认为1。某台Server允许请求失败的次数，超过最大次数后，在fail_timeout时间内，新的请求将不会分配给这台机器。如果设置为0，Nginx会将这台Server置为永久无效状态，然后将请求发给定义了proxy_next_upstream, fastcgi_next_upstream, uwsgi_next_upstream, scgi_next_upstream, and memcached_next_upstream指令来处理这次错误的请求。<br><code>max_conns</code><br>限制分配给某台Server处理的最大连接数量，超过这个数量，将不会分配新的连接给它。默认为0，表示不限制。注意：1.5.9之后的版本才有这个配置</p>
</div><div class="tag"></div>标签:[<a href="/tags/nginx/">nginx</a>,<a href="/tags/负载均衡/">负载均衡</a>]</article></div></section><footer><div class="paginator"><a href="/2016/10/30/js中let和var定义变量的区别/" class="prev">上一篇</a><a href="/2016/10/06/解决mac在QQ视频时候，网页上的视频声音突然变小/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'blog-huangang-net';
var disqus_identifier = '2016/10/17/nginx-负载均衡配置/';
var disqus_title = 'nginx 负载均衡配置';
var disqus_url = 'http://blog.huangang.net/2016/10/17/nginx-负载均衡配置/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-huangang-net.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2023 <a href="http://blog.huangang.net">zorro_ku_o</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-72484043-1",'auto');ga('send','pageview');</script><a href="https://github.com/huangang"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a></body></html>